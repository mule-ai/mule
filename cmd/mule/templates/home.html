{{define "home"}}
<div class="card">
    <h2>Add Repository</h2>
    <form hx-post="/api/repositories/htmx" hx-target="#repositories" hx-swap="outerHTML" hx-indicator="#addRepoIndicator">
        <div class="form-group">
            <label class="label" for="remoteRepository">Remote Repository</label>
            <select id="remoteRepository" name="remoteRepository" class="input" required>
                <option value="">Select a repository...</option>
                {{if .Settings.GitHubToken}}
                    <option value="loading" disabled>Loading...</option>
                {{else}}
                    <option value="" disabled>Enter GitHub Token in Settings to load</option>
                {{end}}
            </select>
            {{if .Settings.GitHubToken}}
            <button type="button" class="button secondary"
                    hx-get="/api/github/repositories/htmx"
                    hx-target="#remoteRepository"
                    hx-swap="innerHTML">
                Refresh Repositories
            </button>
            {{end}}
        </div>
        <div class="form-group">
            <label class="label" for="basePath">Base Path</label>
            <input type="text" id="basePath" name="basePath" class="input" required placeholder="Enter the base path for cloning repository">
        </div>
        <div class="form-group">
            <label class="label" for="schedule">Schedule (cron format)</label>
            <input type="text" id="schedule" name="schedule" class="input" value="0 * * * *" required>
        </div>
        <button type="submit" class="button">Add Repository</button>
        <span id="addRepoIndicator" class="htmx-indicator">Adding...</span>
    </form>
</div>

<div id="repositories">
    {{if .Repositories}}
        {{range $path, $repo := .Repositories}}
            {{template "repositoryCard" $repo}}
        {{end}}
    {{else}}
        <div class="card">
            <p>No repositories added yet. Add one using the form above.</p>
        </div>
    {{end}}
</div>

<!-- Modal structure remains, but content is loaded via HTMX -->
<div id="issuesModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('issuesModal').style.display='none'">&times;</span>
        <h2>Dev Team Issues</h2>
        <div id="issuesList"><p>Click "Show Issues" on a repository to load issues here.</p></div>
    </div>
</div>

<script>
// Script to close the modal if clicked outside of the content
window.onclick = function(event) {
    const modal = document.getElementById('issuesModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Load initial repo options if GitHub token exists
document.addEventListener('DOMContentLoaded', (event) => {
    {{if .Settings.GitHubToken}}
        htmx.ajax('GET', '/api/github/repositories/htmx', '#remoteRepository')
    {{end}}
});
</script>

{{end}}

{{/* Define a reusable template for the repository card */}}
{{define "repositoryCard"}}
<div class="card">
    <div class="repository-header">
        <h3 id="repo-{{.Path | urlquery}}">{{.Path}}</h3>
        <div class="repository-actions">
            <button class="sync-button {{if .Locked}}syncing{{end}}"
                    data-repo-path="{{.Path}}"
                    hx-post="/api/repositories/sync/htmx?path={{.Path | urlquery}}"
                    hx-target="#repo-{{.Path | urlquery}}"
                    hx-swap="outerHTML"
                    hx-indicator="#sync-indicator-{{.Path | urlquery}}"
                    {{if .Locked}}disabled{{end}}>
                <span class="sync-icon"></span>
                <span class="sync-text">{{if .Locked}}Syncing...{{else}}Sync{{end}}</span>
                <span id="sync-indicator-{{.Path | urlquery}}" class="htmx-indicator spinner"></span>
            </button>
            <button class="delete-button"
                    hx-delete="/api/repositories/htmx?path={{.Path | urlquery}}"
                    hx-target="closest .card"
                    hx-swap="outerHTML swap:1s"
                    hx-confirm="Are you sure you want to remove this repository from being tracked? This will not delete any files.">
                Remove
            </button>
        </div>
    </div>
    {{if .State}}
        <p>Branch: <span class="chip {{if .State.HasChanges}}warning{{else}}success{{end}}">
            {{.State.CurrentBranch}}
        </span></p>
        {{if .State.HasChanges}}
            <p>Changed files: {{range .State.ChangedFiles}}{{.}} {{end}}</p>
        {{end}}
    {{end}}
    <p>Provider:
        <select class="provider-select" name="provider" data-repo-path="{{.Path}}"
                hx-post="/api/repositories/provider/htmx?path={{.Path | urlquery}}"
                hx-target="#repo-{{.Path | urlquery}}"
                hx-swap="outerHTML"
                hx-indicator="#provider-indicator-{{.Path | urlquery}}">
            <option value="github" {{if eq .RemoteProvider.Provider "github"}}selected{{end}}>GitHub</option>
            <option value="local" {{if eq .RemoteProvider.Provider "local"}}selected{{end}}>Local</option>
        </select>
        <span id="provider-indicator-{{.Path | urlquery}}" class="htmx-indicator spinner"></span>
    </p>
    <p>Schedule: <span class="chip">{{.Schedule}}</span></p>
    <p>Last Sync: {{.LastSync}}</p>
    <button class="button"
            hx-post="/api/repositories/update/htmx?path={{.Path | urlquery}}"
            hx-target="#repo-{{.Path | urlquery}}" {{/* Assuming update affects the whole card */}}
            hx-swap="outerHTML"
            hx-indicator="#update-indicator-{{.Path | urlquery}}">
            Update Settings {{/* Need to clarify what 'Update' does - assumes updating settings like schedule? */}}
            <span id="update-indicator-{{.Path | urlquery}}" class="htmx-indicator spinner"></span>
    </button>
    {{if eq .RemoteProvider.Provider "local"}}
        <button onclick="window.location.href='/local-provider?path={{.Path | urlquery}}'" class="button">Local Provider</button>
    {{end}}
    <button class="button"
            hx-get="/api/issues/htmx?path={{.Path | urlquery}}"
            hx-target="#issuesList"
            hx-swap="innerHTML"
            hx-indicator="#issues-indicator-{{.Path | urlquery}}"
            onclick="document.getElementById('issuesModal').style.display='block'">
        Show Issues
        <span id="issues-indicator-{{.Path | urlquery}}" class="htmx-indicator spinner"></span>
    </button>
</div>
{{end}}
